/**
 * EJEMPLO DE REFACTORIZACIÓN DE Instances.jsx
 * 
 * Este archivo muestra cómo quedaría el componente principal
 * después de la refactorización completa.
 * 
 * Reducción: De 1276 líneas a ~300 líneas
 * Beneficios:
 * - Código más legible y mantenible
 * - Lógica separada en hooks reutilizables
 * - Modales en componentes independientes
 * - Fácil de testear
 */

import { useState } from 'react';
import { Plus, Search, Filter } from 'lucide-react';

// Hooks personalizados
import { 
  useInstances, 
  useCreationLog, 
  useUpdateLog, 
  useInstanceActions 
} from './hooks';

// Modales
import CreationLogModal from './modals/CreationLogModal';
import UpdateLogModal from './modals/UpdateLogModal';
// import CreateDevModal from './modals/CreateDevModal';  // TODO: Crear
// import CreateProdModal from './modals/CreateProdModal'; // TODO: Crear
// import LogsModal from './modals/LogsModal';             // TODO: Crear

// Componentes reutilizables existentes
import ConfirmModal from '../ConfirmModal';
import Toast from '../Toast';
import GitHubModal from '../GitHubModal';

export default function InstancesRefactored() {
  // ==================== HOOKS PERSONALIZADOS ====================
  const { instanceList, loading, fetchInstances } = useInstances();
  const { creationLog, creationLogRef, startPolling: startCreationPolling, closeLog: closeCreationLog } = useCreationLog();
  const { updateLog, updateLogRef, startPolling: startUpdatePolling, closeLog: closeUpdateLog } = useUpdateLog();
  
  // ==================== ESTADO LOCAL ====================
  const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
  const [confirmModal, setConfirmModal] = useState({ isOpen: false, action: null, instanceName: null });
  const [githubModal, setGithubModal] = useState({ show: false, instanceName: '' });
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showCreateProdModal, setShowCreateProdModal] = useState(false);
  const [filterByProduction, setFilterByProduction] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');

  // ==================== FUNCIONES AUXILIARES ====================
  const showToast = (message, type = 'success') => {
    setToast({ show: true, message, type });
  };

  const { actionLoading, handleAction } = useInstanceActions(
    fetchInstances,
    showToast,
    startUpdatePolling
  );

  const showConfirmation = (action, instanceName) => {
    setConfirmModal({ isOpen: true, action, instanceName });
  };

  const handleConfirmedAction = async () => {
    const { action, instanceName } = confirmModal;
    setConfirmModal({ isOpen: false, action: null, instanceName: null });
    await handleAction(action, instanceName);
  };

  // ==================== FILTRADO Y BÚSQUEDA ====================
  const filteredInstances = instanceList.filter(instance => {
    const matchesSearch = instance.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         instance.domain?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesFilter = filterByProduction === 'all' || 
                         instance.source_instance === filterByProduction;
    return matchesSearch && matchesFilter;
  });

  const productionInstances = filteredInstances.filter(i => i.type === 'production');
  const developmentInstances = filteredInstances.filter(i => i.type === 'development');

  // ==================== RENDERIZADO ====================
  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-600 dark:text-gray-400">Cargando instancias...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* ==================== HEADER ==================== */}
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
          Instancias Odoo
        </h2>
        <div className="flex gap-3">
          <button
            onClick={() => setShowCreateModal(true)}
            className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <Plus className="w-4 h-4" />
            Nueva Dev
          </button>
          <button
            onClick={() => setShowCreateProdModal(true)}
            className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"
          >
            <Plus className="w-4 h-4" />
            Nueva Producción
          </button>
        </div>
      </div>

      {/* ==================== BÚSQUEDA Y FILTROS ==================== */}
      <div className="flex gap-4">
        <div className="flex-1 relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
          <input
            type="text"
            placeholder="Buscar por nombre o dominio..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
          />
        </div>
        <select
          value={filterByProduction}
          onChange={(e) => setFilterByProduction(e.target.value)}
          className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
        >
          <option value="all">Todas las instancias</option>
          {productionInstances.map(instance => (
            <option key={instance.name} value={instance.name}>
              Dev de {instance.name}
            </option>
          ))}
        </select>
      </div>

      {/* ==================== INSTANCIAS DE PRODUCCIÓN ==================== */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div className="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
            Producción ({productionInstances.length})
          </h3>
        </div>
        <div className="p-6">
          {productionInstances.length === 0 ? (
            <p className="text-gray-600 dark:text-gray-300 text-center py-4">
              No hay instancias de producción
            </p>
          ) : (
            <div className="space-y-4">
              {productionInstances.map((instance) => (
                <div key={instance.name} className="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                  {/* TODO: Usar InstanceCard component */}
                  <div className="flex justify-between items-center">
                    <div>
                      <h4 className="font-semibold text-gray-900 dark:text-white">{instance.name}</h4>
                      <p className="text-sm text-gray-600 dark:text-gray-400">{instance.domain}</p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => handleAction('start', instance.name)}
                        disabled={actionLoading[`start-${instance.name}`]}
                        className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                      >
                        Start
                      </button>
                      <button
                        onClick={() => showConfirmation('stop', instance.name)}
                        disabled={actionLoading[`stop-${instance.name}`]}
                        className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
                      >
                        Stop
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* ==================== INSTANCIAS DE DESARROLLO ==================== */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div className="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
            Desarrollo ({developmentInstances.length})
          </h3>
        </div>
        <div className="p-6">
          {developmentInstances.length === 0 ? (
            <p className="text-gray-600 dark:text-gray-300 text-center py-4">
              No hay instancias de desarrollo
            </p>
          ) : (
            <div className="space-y-4">
              {developmentInstances.map((instance) => (
                <div key={instance.name} className="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                  {/* TODO: Usar InstanceCard component */}
                  <div className="flex justify-between items-center">
                    <div>
                      <h4 className="font-semibold text-gray-900 dark:text-white">{instance.name}</h4>
                      <p className="text-sm text-gray-600 dark:text-gray-400">{instance.domain}</p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => handleAction('start', instance.name)}
                        disabled={actionLoading[`start-${instance.name}`]}
                        className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                      >
                        Start
                      </button>
                      <button
                        onClick={() => showConfirmation('delete', instance.name)}
                        disabled={actionLoading[`delete-${instance.name}`]}
                        className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* ==================== MODALES ==================== */}
      <CreationLogModal
        creationLog={creationLog}
        creationLogRef={creationLogRef}
        onClose={closeCreationLog}
      />

      <UpdateLogModal
        updateLog={updateLog}
        updateLogRef={updateLogRef}
        onClose={closeUpdateLog}
      />

      <ConfirmModal
        isOpen={confirmModal.isOpen}
        onClose={() => setConfirmModal({ isOpen: false, action: null, instanceName: null })}
        onConfirm={handleConfirmedAction}
        title={`Confirmar ${confirmModal.action}`}
        message={`¿Estás seguro de que deseas ${confirmModal.action} la instancia ${confirmModal.instanceName}?`}
      />

      <Toast
        show={toast.show}
        message={toast.message}
        type={toast.type}
        onClose={() => setToast({ show: false, message: '', type: 'success' })}
      />

      <GitHubModal
        show={githubModal.show}
        instanceName={githubModal.instanceName}
        onClose={() => setGithubModal({ show: false, instanceName: '' })}
      />

      {/* TODO: Agregar CreateDevModal */}
      {/* TODO: Agregar CreateProdModal */}
      {/* TODO: Agregar LogsModal */}
    </div>
  );
}
